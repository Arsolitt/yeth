# yeth

Утилита для построения графа зависимостей между приложениями и вычисления их хэшей.

## Как это работает

1. Сканирует директории в поисках файлов `yeth.toml`
2. Строит граф зависимостей между приложениями
3. Проверяет на циклические зависимости
4. Вычисляет хэш каждого приложения с учётом хэшей его зависимостей
5. Выводит результаты

## Установка

```bash
cargo build --release
```

Бинарник будет в `target/release/yeth`

## Использование

### Базовое использование

Вывести хэши всех приложений:

```bash
yeth
```

### Вывод хэша конкретного приложения

```bash
yeth --app my-app
```

### Вывод только хэша (без имени)

Полезно для скриптов:

```bash
yeth --app my-app --hash-only
```

### Указать корневую директорию

```bash
yeth --root /path/to/monorepo
```

### Показать граф зависимостей

```bash
yeth --show-graph
```

### Тихий режим (без статистики)

```bash
yeth --verbose
```

## Формат конфигурации

Создайте файл `yeth.toml` в корне каждого приложения:

```toml
[app]
dependencies = ["app1", "app2"]
```

Если у приложения нет зависимостей:

```toml
[app]
dependencies = []
```

### Типы зависимостей

Можно указывать два типа зависимостей:

1. **Зависимости от других приложений** (имена без слэшей):
```toml
[app]
dependencies = ["app1", "backend", "shared"]
```

2. **Зависимости от файлов и директорий** (относительные пути):
```toml
[app]
dependencies = [
    "../shared/config.json",      # файл
    "./vendor",                    # директория
    "../../../root-config.yaml"   # путь вверх по дереву
]
```

3. **Смешанные зависимости**:
```toml
[app]
dependencies = [
    "app1",                    # зависимость от приложения
    "../shared/utils",         # зависимость от директории
    "./config.json"            # зависимость от файла
]
```

**Правило определения типа:**
- Если строка содержит `/` или начинается с `.` → это путь к файлу/директории
- Иначе → это имя приложения

**Важно:** Пути разрешаются относительно директории приложения (где находится `yeth.toml`).

### Исключение файлов из хэширования

Можно указать файлы и директории, которые нужно исключить из вычисления хэша приложения:

```toml
[app]
dependencies = ["app1"]
exclude = [
    "node_modules",           # игнорировать директорию node_modules
    "dist",                   # игнорировать директорию dist
    "target",                 # игнорировать директорию target
    ".env",                   # игнорировать файл .env
    "tests",                  # игнорировать всё в tests/
    "src/generated"           # игнорировать src/generated/
]
```

**Как работает исключение:**
- Паттерны проверяются относительно корня приложения
- Можно указать имя директории (`node_modules`) — будет исключена везде где встретится
- Можно указать путь (`src/generated`) — будет исключён конкретный путь
- Префиксное совпадение: если путь начинается с паттерна, он исключается
- **Важно:** Паттерны с путями (`../shared/README.md`) применяются глобально — исключат файлы даже внутри зависимостей

**Примеры:**

```toml
# Базовая конфигурация без исключений
[app]
dependencies = []

# С исключениями локальных файлов
[app]
dependencies = ["backend"]
exclude = ["node_modules", "dist", "tmp"]

# Исключение файлов из зависимостей
[app]
dependencies = ["../shared"]
exclude = ["../shared/README.md", "../shared/docs"]

# Комбинированное исключение
[app]
dependencies = ["../shared", "../common"]
exclude = [
    "node_modules",              # локальное исключение
    "../shared/README.md",       # исключение из зависимости
    "../common/tests"            # исключение директории из зависимости
]
```

## Примеры

### Структура проекта

#### Пример 1: Только зависимости между приложениями

```
monorepo/
├── app1/
│   ├── yeth.toml      # dependencies = []
│   └── src/
├── app2/
│   ├── yeth.toml      # dependencies = ["app1"]
│   └── src/
└── app3/
    ├── yeth.toml      # dependencies = ["app1", "app2"]
    └── src/
```

#### Пример 2: С зависимостями от файлов и директорий

```
monorepo/
├── shared/
│   ├── config.json
│   └── utils/
├── apps/
│   ├── frontend/
│   │   ├── yeth.toml      # dependencies = ["backend", "../../shared/config.json"]
│   │   │                  # exclude = ["node_modules", "dist"]
│   │   ├── node_modules/
│   │   ├── dist/
│   │   └── src/
│   └── backend/
│       ├── yeth.toml      # dependencies = ["../../shared/utils"]
│       │                  # exclude = ["target"]
│       ├── target/
│       └── src/
└── config.yaml
```

**Конфиг frontend/yeth.toml:**
```toml
[app]
dependencies = ["backend", "../../shared/config.json"]
exclude = ["node_modules", "dist", ".next"]
```

**Конфиг backend/yeth.toml:**
```toml
[app]
dependencies = ["../../shared/utils"]
exclude = ["target", "*.log"]
```

### Примеры вывода

#### Обычный вывод

```bash
$ yeth
a1b2c3d4... app1
e5f6g7h8... app2
i9j0k1l2... app3

Время выполнения: 123.45ms
Обработано приложений: 3
```

#### Граф зависимостей

```bash
$ yeth --show-graph
Граф зависимостей:

app1
  └─ (нет зависимостей)

app2
  ├─ app1 (app)
  └─ ../shared/config.json (file)

app3
  ├─ app1 (app)
  ├─ app2 (app)
  └─ ../shared/utils (dir)
```

### Использование в CI/CD

Получить хэш приложения для определения нужно ли его пересобирать:

```bash
#!/bin/bash
APP_HASH=$(yeth --app my-app --hash-only --verbose)
echo "Текущий хэш: $APP_HASH"

# Сравнить с сохранённым хэшом и решить нужна ли пересборка
if [ "$APP_HASH" != "$LAST_BUILD_HASH" ]; then
    echo "Изменения обнаружены, запускаем сборку..."
    # build commands here
fi
```

### Практический пример 1: Простое исключение

Структура проекта:
```
example/
├── app1/
│   ├── yeth.toml          # dependencies = [], exclude = ["node_modules", "dist"]
│   ├── main.js
│   ├── node_modules/      # исключено из хэша
│   └── dist/              # исключено из хэша
└── app2/
    ├── yeth.toml          # dependencies = ["app1"], exclude = ["target"]
    ├── main.rs
    └── target/            # исключено из хэша
```

**Важно:** Файлы в `node_modules`, `dist` и `target` не влияют на хэш, т.к. указаны в `exclude`.

### Практический пример 2: Исключение файлов из зависимостей

Структура:
```
example/
├── catalog/
│   ├── yeth.toml          # dependencies = ["../shared"]
│   │                      # exclude = ["../shared/README.md"]
│   └── index.js
└── shared/
    ├── yeth.toml
    ├── utils.js
    └── README.md          # исключено из хэша catalog, но НЕ исключено из хэша shared
```

**Конфиг catalog/yeth.toml:**
```toml
[app]
dependencies = ["../shared"]
exclude = ["../shared/README.md", "node_modules"]
```

**Результат:**
- Изменение `shared/README.md` → хэш `catalog` **НЕ меняется** ✅
- Изменение `shared/README.md` → хэш `shared` **меняется** (у него нет этого исключения)
- Изменение `shared/utils.js` → хэш `catalog` **меняется** ✅

Запуск:
```bash
$ yeth --root example
47aa9e986c6e4c0b7bd839d97eda81700fccc8575e1cfa8cf7ce70809c4bfb1e catalog
d98a899314cd6581de6446f1a427a9822013b3065a92a38f61d381571c86da7d shared

# Изменяем shared/README.md
$ echo "update" >> shared/README.md
$ yeth --root example
47aa9e986c6e4c0b7bd839d97eda81700fccc8575e1cfa8cf7ce70809c4bfb1e catalog  ← не изменился
00214c62f5d76e98dac137675059581576eeabfc8d084dc8b6206f84dd84f692 shared  ← изменился

# Изменяем shared/utils.js
$ echo "update" >> shared/utils.js  
$ yeth --root example
54010998be564b7a736a48e418084ec3247c23e8d2d5d1ba8c4065d75ea988fa catalog  ← изменился
25116e4ece02de6be08a5093f3b867092e0b1df4713f087470bb932afe5785bb shared  ← изменился
```

## Опции командной строки

```
Options:
  -r, --root <ROOT>      Корневая директория для поиска приложений [default: .]
  -a, --app <APP>        Имя конкретного приложения для вывода хэша
  -H, --hash-only        Показывать только хэш без имени приложения
  -v, --verbose            Не показывать статистику времени выполнения
  -g, --show-graph       Показать граф зависимостей
  -h, --help             Print help
```

## Архитектура

Проект разбит на модули:

- `cli.rs` - Парсинг аргументов командной строки (clap)
- `config.rs` - Чтение и парсинг конфигурационных файлов
- `graph.rs` - Построение графа зависимостей и топологическая сортировка
- `hash.rs` - Вычисление хэшей директорий и приложений
- `main.rs` - Точка входа и координация работы

## Алгоритм вычисления хэша

1. Для каждого приложения вычисляется собственный хэш (SHA256 всех файлов в директории)
2. Для зависимостей-путей вычисляется хэш файла или директории
3. Приложения обрабатываются в топологическом порядке (по зависимостям между приложениями)
4. Финальный хэш = SHA256(собственный_хэш + хэш_зависимости_1 + ... + хэш_зависимости_N)

**Важные моменты:**
- Изменение в любой зависимости (приложении, файле, директории) повлияет на хэш всех зависящих от неё приложений
- Зависимости от файлов/директорий не участвуют в топологической сортировке (они не могут быть циклическими)
- Зависимости-пути проверяются на существование при старте программы
- Автоматически игнорируются системные файлы (`.git`, `.DS_Store`)
- Дополнительно можно указать файлы для исключения через поле `exclude` в конфиге
